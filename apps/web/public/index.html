<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Swarm Status</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "ui-sans-serif", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>
  </head>
  <body class="min-h-screen bg-zinc-950 text-zinc-100 antialiased">
    <canvas id="bg-canvas" class="fixed inset-0 z-0 pointer-events-none opacity-30"></canvas>

    <div class="relative z-10">
      <div class="mx-auto max-w-7xl px-5 pb-16 pt-8 sm:px-8 lg:px-10">
        <header class="relative overflow-hidden rounded-2xl border border-zinc-800 bg-zinc-900 p-6 shadow-lg shadow-white/10 sm:p-8">
          <div class="relative flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-zinc-400">AI Swarm Control Plane</p>
              <h1 class="mt-2 text-3xl font-semibold tracking-tight text-white sm:text-4xl">Queue &amp; Run Status Dashboard</h1>
              <p class="mt-3 text-sm text-zinc-400 sm:text-base">Live visibility into orchestrator queue state and runner outcomes.</p>
            </div>
            <div class="grid gap-3 sm:grid-cols-2">
              <div class="rounded-xl border border-zinc-800 bg-black px-4 py-3 shadow-md shadow-white/5">
                <p class="text-[11px] font-semibold uppercase tracking-[0.18em] text-zinc-500">Target Repository</p>
                <p id="target-repo" class="mt-1 text-sm font-semibold text-white sm:text-base">Unknown / Unknown</p>
              </div>
              <div class="rounded-xl border border-zinc-800 bg-black px-4 py-3 shadow-md shadow-white/5">
                <p class="text-[11px] font-semibold uppercase tracking-[0.18em] text-zinc-500">Last Refresh</p>
                <p id="last-refresh" class="mt-1 text-sm font-medium text-zinc-200 sm:text-base">Waiting for data...</p>
              </div>
            </div>
          </div>
        </header>

        <div id="error-banner" class="mt-5 hidden rounded-xl border border-zinc-700 bg-zinc-900 px-4 py-3 text-sm font-medium text-zinc-200 shadow-md shadow-white/5"></div>

        <main class="mt-7 grid gap-6 xl:grid-cols-5">
          <section class="xl:col-span-3 rounded-2xl border border-zinc-800 bg-zinc-900 p-5 shadow-lg shadow-white/10 sm:p-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div>
                <h2 class="text-xl font-semibold tracking-tight text-white">Orchestrator State</h2>
                <p class="mt-1 text-sm text-zinc-400">Current sprint queue with status and dispatch context.</p>
              </div>
              <div class="rounded-full border border-zinc-700 bg-black px-4 py-2 text-sm font-medium text-zinc-300">
                Sprint: <span id="orchestrator-sprint" class="font-semibold text-white">N/A</span>
              </div>
            </div>

            <div id="orchestrator-summary" class="mt-5 flex flex-wrap gap-2"></div>
            <div id="orchestrator-items" class="mt-5 space-y-3"></div>
          </section>

          <section class="xl:col-span-2 rounded-2xl border border-zinc-800 bg-zinc-900 p-5 shadow-lg shadow-white/10 sm:p-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div>
                <h2 class="text-xl font-semibold tracking-tight text-white">Runner Ledger</h2>
                <p class="mt-1 text-sm text-zinc-400">Recent executor/reviewer runs and outcomes.</p>
              </div>
              <div
                id="runner-count"
                class="rounded-full border border-zinc-700 bg-black px-3 py-1 text-xs font-semibold uppercase tracking-[0.16em] text-zinc-300"
              >
                0 Runs
              </div>
            </div>

            <div id="runner-runs" class="mt-5 space-y-4"></div>
          </section>
        </main>
      </div>
    </div>

    <script>
      const POLL_INTERVAL_MS = 15000;
      const orchestratorItemsEl = document.getElementById("orchestrator-items");
      const orchestratorSummaryEl = document.getElementById("orchestrator-summary");
      const orchestratorSprintEl = document.getElementById("orchestrator-sprint");
      const runnerRunsEl = document.getElementById("runner-runs");
      const runnerCountEl = document.getElementById("runner-count");
      const targetRepoEl = document.getElementById("target-repo");
      const lastRefreshEl = document.getElementById("last-refresh");
      const errorBannerEl = document.getElementById("error-banner");

      const canvas = document.getElementById("bg-canvas");
      const ctx = canvas.getContext("2d");
      const nodes = [];
      let canvasWidth = 0;
      let canvasHeight = 0;
      let animationFrameId = 0;
      let activityTarget = 0.12;
      let activityCurrent = 0.12;
      let lastFrameTime = performance.now();

      function asObject(value) {
        return value && typeof value === "object" && !Array.isArray(value) ? value : {};
      }

      function escapeHtml(value) {
        return String(value ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function formatTime(value) {
        const parsed = new Date(value ?? "");
        if (Number.isNaN(parsed.getTime())) {
          return "Unknown time";
        }
        return parsed.toLocaleString();
      }

      function statusBadgeClasses(status) {
        const normalized = String(status ?? "").trim();
        if (normalized === "Done") return "bg-white text-black border border-white/80";
        if (normalized === "In Progress") return "bg-zinc-200 text-zinc-950 border border-zinc-300";
        if (normalized === "In Review") return "bg-zinc-300 text-zinc-950 border border-zinc-300";
        if (normalized === "Ready") return "bg-zinc-100 text-zinc-950 border border-zinc-200";
        if (normalized === "Blocked") return "bg-zinc-800 text-zinc-100 border border-zinc-600";
        if (normalized === "Needs Human Approval") return "bg-zinc-700 text-zinc-100 border border-zinc-500";
        if (normalized === "Backlog") return "bg-zinc-900 text-zinc-300 border border-zinc-700";
        return "bg-zinc-900 text-zinc-300 border border-zinc-700";
      }

      function runBadgeClasses(status) {
        const normalized = String(status ?? "").toLowerCase();
        if (normalized === "succeeded") return "bg-white text-black border border-white/80";
        if (normalized === "running") return "bg-zinc-200 text-zinc-950 border border-zinc-300";
        if (normalized === "queued") return "bg-zinc-300 text-zinc-950 border border-zinc-300";
        if (normalized === "failed") return "bg-zinc-800 text-zinc-100 border border-zinc-600";
        if (normalized === "skipped") return "bg-zinc-900 text-zinc-300 border border-zinc-700";
        return "bg-zinc-900 text-zinc-300 border border-zinc-700";
      }

      function deriveTargetFromData(orchestrator, runner, ownerHeader, repoHeader) {
        if (ownerHeader && repoHeader) {
          return `${ownerHeader}/${repoHeader}`;
        }

        const runnerEntries = Object.values(asObject(runner));
        for (const entry of runnerEntries) {
          const prUrl =
            entry?.result?.pr_url ??
            entry?.result?.urls?.pr_url ??
            entry?.result?.urls?.pull_request ??
            entry?.result?.pull_request_url;
          if (typeof prUrl !== "string") {
            continue;
          }
          const match = prUrl.match(/github\.com\/([^/]+)\/([^/]+)/i);
          if (match?.[1] && match?.[2]) {
            return `${match[1]}/${match[2]}`;
          }
        }

        const sprintPlanTarget = orchestrator?.sprint_plan?.target;
        if (typeof sprintPlanTarget === "string" && sprintPlanTarget.includes("/")) {
          return sprintPlanTarget;
        }

        return "Unknown / Unknown";
      }

      function deriveSprint(orchestrator) {
        const sprintFromPlan = orchestrator?.sprint_plan?.sprint;
        if (typeof sprintFromPlan === "string" && sprintFromPlan.trim()) {
          return sprintFromPlan.trim();
        }

        const items = Object.values(asObject(orchestrator?.items));
        for (const item of items) {
          const sprint = item?.last_seen_sprint;
          if (typeof sprint === "string" && sprint.trim()) {
            return sprint.trim();
          }
        }

        return "N/A";
      }

      function computeAnimationActivity(orchestrator, runner) {
        const items = Object.values(asObject(orchestrator?.items));
        const activeItemStatuses = new Set([
          "Ready",
          "In Progress",
          "In Review",
          "Needs Human Approval",
          "Blocked",
        ]);

        const hasActiveQueueItems = items.some((item) => activeItemStatuses.has(String(item?.last_seen_status ?? "")));

        const runs = Object.values(asObject(runner));
        const hasRunningRun = runs.some((run) => String(run?.status ?? "").toLowerCase() === "running");

        activityTarget = hasActiveQueueItems || hasRunningRun ? 1 : 0.12;
      }

      function renderOrchestrator(orchestrator) {
        const itemsObj = asObject(orchestrator?.items);
        const entries = Object.entries(itemsObj)
          .map(([projectItemId, value]) => ({
            projectItemId,
            issueNumber: Number(value?.last_seen_issue_number ?? 0),
            status: String(value?.last_seen_status ?? "Unknown"),
            lastSeenAt: value?.last_seen_at ?? "",
            statusSinceAt: value?.status_since_at ?? "",
            lastRole: value?.last_dispatched_role ?? "",
            lastRunId: value?.last_run_id ?? "",
            reviewCycles: Number(value?.review_cycle_count ?? 0),
          }))
          .sort((left, right) => {
            if (left.issueNumber && right.issueNumber && left.issueNumber !== right.issueNumber) {
              return left.issueNumber - right.issueNumber;
            }
            return String(left.projectItemId).localeCompare(String(right.projectItemId));
          });

        const statusCounts = {};
        for (const entry of entries) {
          statusCounts[entry.status] = (statusCounts[entry.status] ?? 0) + 1;
        }

        orchestratorSummaryEl.innerHTML = "";
        const statusPairs = Object.entries(statusCounts);
        if (statusPairs.length > 0) {
          orchestratorSummaryEl.innerHTML = statusPairs
            .map(
              ([status, count]) =>
                `<span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ${statusBadgeClasses(status)}">${escapeHtml(status)} <span class="text-[11px] opacity-80">${count}</span></span>`,
            )
            .join("");
        }

        if (entries.length === 0) {
          orchestratorItemsEl.innerHTML = `
            <div class="rounded-2xl border border-dashed border-zinc-700 bg-black px-6 py-10 text-center">
              <p class="text-sm font-semibold text-zinc-200">No queue activity yet</p>
              <p class="mt-2 text-sm text-zinc-500">When orchestrator state appears, sprint items will show up here with live status badges.</p>
            </div>
          `;
          return;
        }

        orchestratorItemsEl.innerHTML = entries
          .map(
            (entry) => `
              <article class="rounded-xl border border-zinc-800 bg-black p-4 shadow-md shadow-white/5 transition hover:-translate-y-0.5 hover:shadow-lg hover:shadow-white/10">
                <div class="flex flex-wrap items-start justify-between gap-3">
                  <div>
                    <p class="text-xs font-medium uppercase tracking-[0.16em] text-zinc-500">Project Item</p>
                    <h3 class="mt-1 text-base font-semibold text-white">${entry.issueNumber > 0 ? `#${entry.issueNumber}` : "Unnumbered Issue"} · ${escapeHtml(entry.projectItemId)}</h3>
                  </div>
                  <span class="inline-flex rounded-full px-3 py-1 text-xs font-semibold ${statusBadgeClasses(entry.status)}">${escapeHtml(entry.status)}</span>
                </div>
                <div class="mt-3 grid gap-2 text-xs text-zinc-400 sm:grid-cols-2">
                  <p>Last seen: <span class="font-medium text-zinc-200">${escapeHtml(formatTime(entry.lastSeenAt))}</span></p>
                  <p>In status since: <span class="font-medium text-zinc-200">${escapeHtml(formatTime(entry.statusSinceAt))}</span></p>
                  <p>Last dispatch role: <span class="font-medium text-zinc-200">${escapeHtml(entry.lastRole || "—")}</span></p>
                  <p>Review cycles: <span class="font-medium text-zinc-200">${Number.isFinite(entry.reviewCycles) ? entry.reviewCycles : 0}</span></p>
                </div>
                ${
                  entry.lastRunId
                    ? `<p class="mt-3 rounded-lg border border-zinc-800 bg-zinc-900/70 px-3 py-2 text-[11px] text-zinc-500">run_id: <span class="font-mono text-[11px] text-zinc-300">${escapeHtml(entry.lastRunId)}</span></p>`
                    : ""
                }
              </article>
            `,
          )
          .join("");
      }

      function renderRunner(runner) {
        const entries = Object.values(asObject(runner))
          .filter((value) => value && typeof value === "object")
          .map((value) => {
            const timestamp =
              value?.running_at ??
              value?.result?.completed_at ??
              value?.result?.finished_at ??
              value?.result?.updated_at ??
              value?.received_at;

            const blockedReason =
              value?.result?.blocked_reason ??
              value?.result?.reason ??
              value?.result?.error ??
              value?.result?.message ??
              "";

            return {
              runId: value?.run_id ?? "",
              role: value?.role ?? "UNKNOWN",
              status: value?.status ?? "unknown",
              timestamp,
              receivedAt: value?.received_at ?? "",
              outcome: value?.result?.outcome ?? "",
              blockedReason: typeof blockedReason === "string" ? blockedReason : "",
              prUrl:
                value?.result?.pr_url ??
                value?.result?.urls?.pr_url ??
                value?.result?.urls?.pull_request ??
                "",
            };
          })
          .sort((left, right) => {
            const leftMs = new Date(left.timestamp ?? "").getTime();
            const rightMs = new Date(right.timestamp ?? "").getTime();
            if (Number.isNaN(leftMs) && Number.isNaN(rightMs)) return 0;
            if (Number.isNaN(leftMs)) return 1;
            if (Number.isNaN(rightMs)) return -1;
            return rightMs - leftMs;
          })
          .slice(0, 30);

        runnerCountEl.textContent = `${entries.length} Run${entries.length === 1 ? "" : "s"}`;

        if (entries.length === 0) {
          runnerRunsEl.innerHTML = `
            <div class="rounded-2xl border border-dashed border-zinc-700 bg-black px-5 py-10 text-center">
              <p class="text-sm font-semibold text-zinc-200">No runner entries yet</p>
              <p class="mt-2 text-sm text-zinc-500">As runs are queued and executed, this timeline will populate automatically.</p>
            </div>
          `;
          return;
        }

        runnerRunsEl.innerHTML = entries
          .map((entry) => {
            const normalizedStatus = String(entry.status ?? "").toLowerCase();
            const showBlocked = normalizedStatus === "failed" || normalizedStatus === "blocked";
            return `
              <article class="relative rounded-xl border border-zinc-800 bg-black p-4 shadow-md shadow-white/5">
                <div class="absolute left-0 top-5 h-4 w-1 rounded-r-full ${showBlocked ? "bg-zinc-500" : "bg-white/70"}"></div>
                <div class="flex flex-wrap items-start justify-between gap-3 pl-3">
                  <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.16em] text-zinc-500">${escapeHtml(entry.role)}</p>
                    <p class="mt-1 text-sm font-semibold text-white">${entry.runId ? escapeHtml(entry.runId) : "Unknown run"}</p>
                    <p class="mt-1 text-xs text-zinc-500">${escapeHtml(formatTime(entry.timestamp || entry.receivedAt))}</p>
                  </div>
                  <span class="inline-flex rounded-full px-3 py-1 text-xs font-semibold ${runBadgeClasses(entry.status)}">${escapeHtml(String(entry.status).toUpperCase())}</span>
                </div>
                ${
                  entry.outcome
                    ? `<p class="mt-3 pl-3 text-xs text-zinc-400">Outcome: <span class="font-semibold text-zinc-200">${escapeHtml(entry.outcome)}</span></p>`
                    : ""
                }
                ${
                  showBlocked && entry.blockedReason
                    ? `<p class="mt-3 rounded-lg border border-zinc-700 bg-zinc-900/80 px-3 py-2 text-xs text-zinc-300">Blocked reason: ${escapeHtml(entry.blockedReason)}</p>`
                    : ""
                }
                ${
                  entry.prUrl
                    ? `<a class="mt-3 inline-flex pl-3 text-xs font-semibold text-zinc-200 underline decoration-zinc-600 underline-offset-4 hover:text-white" target="_blank" rel="noreferrer" href="${escapeHtml(entry.prUrl)}">Open linked PR</a>`
                    : ""
                }
              </article>
            `;
          })
          .join("");
      }

      function showError(message) {
        errorBannerEl.textContent = message;
        errorBannerEl.classList.remove("hidden");
      }

      function clearError() {
        errorBannerEl.textContent = "";
        errorBannerEl.classList.add("hidden");
      }

      function resizeCanvas() {
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        canvasWidth = window.innerWidth;
        canvasHeight = window.innerHeight;
        canvas.width = Math.floor(canvasWidth * dpr);
        canvas.height = Math.floor(canvasHeight * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        const targetCount = Math.min(140, Math.max(55, Math.floor((canvasWidth * canvasHeight) / 22000)));

        if (nodes.length > targetCount) {
          nodes.length = targetCount;
        }

        while (nodes.length < targetCount) {
          nodes.push({
            x: Math.random() * canvasWidth,
            y: Math.random() * canvasHeight,
            vx: (Math.random() * 2 - 1) * 0.35,
            vy: (Math.random() * 2 - 1) * 0.35,
            size: Math.random() * 1.5 + 0.6,
          });
        }
      }

      function animateBackground(now) {
        const dt = Math.min(0.05, (now - lastFrameTime) / 1000 || 0.016);
        lastFrameTime = now;

        activityCurrent += (activityTarget - activityCurrent) * 0.04;

        const speedScale = 0.18 + activityCurrent * 1.9;
        const connectionDistance = 95 + activityCurrent * 90;
        const connectionDistanceSquared = connectionDistance * connectionDistance;
        const lineBaseAlpha = 0.03 + activityCurrent * 0.24;
        const nodeAlpha = 0.2 + activityCurrent * 0.6;

        ctx.clearRect(0, 0, canvasWidth, canvasHeight);

        for (let i = 0; i < nodes.length; i += 1) {
          const node = nodes[i];

          node.x += node.vx * speedScale * (dt * 60);
          node.y += node.vy * speedScale * (dt * 60);

          if (node.x < -20) node.x = canvasWidth + 20;
          if (node.x > canvasWidth + 20) node.x = -20;
          if (node.y < -20) node.y = canvasHeight + 20;
          if (node.y > canvasHeight + 20) node.y = -20;
        }

        for (let i = 0; i < nodes.length; i += 1) {
          const a = nodes[i];
          for (let j = i + 1; j < nodes.length; j += 1) {
            const b = nodes[j];
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const distanceSquared = dx * dx + dy * dy;
            if (distanceSquared > connectionDistanceSquared) {
              continue;
            }

            const distance = Math.sqrt(distanceSquared);
            const t = 1 - distance / connectionDistance;
            ctx.strokeStyle = `rgba(255,255,255,${(lineBaseAlpha * t).toFixed(4)})`;
            ctx.lineWidth = 0.5 + t * 0.9;
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            ctx.stroke();
          }
        }

        for (const node of nodes) {
          ctx.fillStyle = `rgba(255,255,255,${(nodeAlpha * 0.7).toFixed(4)})`;
          ctx.beginPath();
          ctx.arc(node.x, node.y, node.size, 0, Math.PI * 2);
          ctx.fill();
        }

        animationFrameId = window.requestAnimationFrame(animateBackground);
      }

      async function loadStatus() {
        try {
          const response = await fetch("/internal/status", { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const payload = asObject(await response.json());
          const orchestrator = asObject(payload?.orchestrator);
          const runner = asObject(payload?.runner);

          const ownerHeader = response.headers.get("x-target-owner") ?? "";
          const repoHeader = response.headers.get("x-target-repo") ?? "";

          targetRepoEl.textContent = deriveTargetFromData(orchestrator, runner, ownerHeader, repoHeader);
          orchestratorSprintEl.textContent = deriveSprint(orchestrator);
          renderOrchestrator(orchestrator);
          renderRunner(runner);
          computeAnimationActivity(orchestrator, runner);
          lastRefreshEl.textContent = formatTime(new Date().toISOString());
          clearError();
        } catch (error) {
          showError(`Unable to refresh status data: ${error?.message ?? "Unknown error"}`);
          lastRefreshEl.textContent = "Refresh failed";
          activityTarget = 0.12;
        }
      }

      window.addEventListener("resize", resizeCanvas, { passive: true });
      resizeCanvas();
      animationFrameId = window.requestAnimationFrame(animateBackground);

      loadStatus();
      setInterval(loadStatus, POLL_INTERVAL_MS);

      window.addEventListener("beforeunload", () => {
        if (animationFrameId) {
          window.cancelAnimationFrame(animationFrameId);
        }
      });
    </script>
  </body>
</html>
